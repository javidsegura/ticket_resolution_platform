name: CI - Backend

on:
  push:
    branches:
      - '**'
    paths:
      - 'backend/**'
      - 'e2e/**'
      - '.github/workflows/ci-backend.yml'
  pull_request:
    branches:
      - '**'
    paths:
      - 'backend/**'
      - 'e2e/**'

env:
  PYTHON_VERSION: '3.11'
  WORKING_DIR: ./backend

jobs:
  # ------------------------------------------------------------------
  # STAGE 1: FAST CHECKS
  # ------------------------------------------------------------------
  lint-and-security:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: make install

      - name: Run linting checks
        run: make format

      - name: Run security scan
        run: make static-security-analysis

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: backend/bandit-report.json

  unit-tests:
    runs-on: ubuntu-latest
    needs: lint-and-security
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: make install-full

      - name: Create Test Environment Config
        run: |
          mkdir -p env_config/synced
          cat > env_config/synced/.env.test << EOF
          ENVIRONMENT="test"
          CLOUD_PROVIDER="azure"
          USING_FIREBASE_EMULATOR="true"
          FB_AUTH_EMULATOR_HOST="localhost:19099"
          FB_PROJECT_ID="url-shortener-abadb"
          REDIS_URL="redis://localhost:6379"
          MYSQL_USER="root"
          MYSQL_PASSWORD="rootpassword"
          MYSQL_HOST="localhost"
          MYSQL_PORT="3307"
          MYSQL_DATABASE="ai_ticket_platform"
          MYSQL_SYNC_DRIVER="mysql+pymysql"
          MYSQL_ASYNC_DRIVER="mysql+aiomysql"
          AWS_MAIN_REGION="us-east-1"
          S3_MAIN_BUCKET_NAME="test-bucket"
          AZURE_STORAGE_ACCOUNT_NAME="storage_acc"
          AZURE_STORAGE_ACCOUNT_KEY="storage_acc_key"
          AZURE_STORAGE_CONTAINER_NAME="images"
          OPENAI_API_KEY="test-key-123"
          SLACK_BOT_TOKEN="xoxb-test-token"
          GEMINI_API_KEY="test-gemini-key"
          CHROMA_HOST="localhost"
          CHROMA_PORT="8001"
          CHROMA_COLLECTION_NAME="ticket_embeddings"
          GEMINI_MODEL="gemini-1.5-flash"
          FRONTEND_URL="http://localhost:5173"
          SLACK_CHANNEL_ID="test-channel"
          REDIS_MAX_CONNECTIONS="10"
          EOF

      - name: Run Unit Tests
        env:
          ENVIRONMENT: test
        run: make unit-test

      - name: Upload coverage results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/coverage.xml

  # ------------------------------------------------------------------
  # STAGE 2: SMOKE TESTS (Verify Docker Services)
  # ------------------------------------------------------------------
  smoke-tests:
    runs-on: ubuntu-latest
    needs: [lint-and-security, unit-tests]
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: make install

      - name: Create Test Environment Config
        run: |
          mkdir -p env_config/synced
          cat > env_config/synced/.env.test << EOF
          ENVIRONMENT="test"
          CLOUD_PROVIDER="azure"
          USING_FIREBASE_EMULATOR="true"
          FB_AUTH_EMULATOR_HOST="localhost:19099"
          FB_PROJECT_ID="url-shortener-abadb"
          REDIS_URL="redis://localhost:6379"
          MYSQL_USER="root"
          MYSQL_PASSWORD="rootpassword"
          MYSQL_HOST="localhost"
          MYSQL_PORT="3307"
          MYSQL_DATABASE="ai_ticket_platform"
          MYSQL_SYNC_DRIVER="mysql+pymysql"
          MYSQL_ASYNC_DRIVER="mysql+aiomysql"
          AWS_MAIN_REGION="us-east-1"
          S3_MAIN_BUCKET_NAME="test-bucket"
          AZURE_STORAGE_ACCOUNT_NAME="storage_acc"
          AZURE_STORAGE_ACCOUNT_KEY="storage_acc_key"
          AZURE_STORAGE_CONTAINER_NAME="images"
          OPENAI_API_KEY="test-key-123"
          SLACK_BOT_TOKEN="xoxb-test-token"
          GEMINI_API_KEY="test-gemini-key"
          CHROMA_HOST="localhost"
          CHROMA_PORT="8001"
          CHROMA_COLLECTION_NAME="ticket_embeddings"
          GEMINI_MODEL="gemini-1.5-flash"
          FRONTEND_URL="http://localhost:5173"
          SLACK_CHANNEL_ID="test-channel"
          REDIS_MAX_CONNECTIONS="10"
          EOF

      - name: Start Docker Test Services
        env:
          ENVIRONMENT: test
        run: |
          make test-start
          echo "Waiting for services to stabilize..."
          sleep 15

      - name: Run Smoke Tests
        env:
          ENVIRONMENT: test
        run: make smoke-test

      - name: Stop Docker Environment
        if: always()
        env:
          ENVIRONMENT: test
        run: make test-stop

  # ------------------------------------------------------------------
  # STAGE 3: INTEGRATION TESTS (includes E2E workflows)
  # ------------------------------------------------------------------
  integration-tests:
    runs-on: ubuntu-latest
    needs: [smoke-tests]
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: make install

      - name: Create Test Environment Config
        run: |
          mkdir -p env_config/synced
          cat > env_config/synced/.env.test << EOF
          ENVIRONMENT="test"
          CLOUD_PROVIDER="azure"
          USING_FIREBASE_EMULATOR="true"
          FB_AUTH_EMULATOR_HOST="localhost:19099"
          FB_PROJECT_ID="url-shortener-abadb"
          REDIS_URL="redis://localhost:6379"
          MYSQL_USER="root"
          MYSQL_PASSWORD="rootpassword"
          MYSQL_HOST="localhost"
          MYSQL_PORT="3307"
          MYSQL_DATABASE="ai_ticket_platform"
          MYSQL_SYNC_DRIVER="mysql+pymysql"
          MYSQL_ASYNC_DRIVER="mysql+aiomysql"
          AWS_MAIN_REGION="us-east-1"
          S3_MAIN_BUCKET_NAME="test-bucket"
          AZURE_STORAGE_ACCOUNT_NAME="storage_acc"
          AZURE_STORAGE_ACCOUNT_KEY="storage_acc_key"
          AZURE_STORAGE_CONTAINER_NAME="images"
          OPENAI_API_KEY="test-key-123"
          SLACK_BOT_TOKEN="xoxb-test-token"
          GEMINI_API_KEY="test-gemini-key"
          CHROMA_HOST="localhost"
          CHROMA_PORT="8001"
          CHROMA_COLLECTION_NAME="ticket_embeddings"
          GEMINI_MODEL="gemini-1.5-flash"
          FRONTEND_URL="http://localhost:5173"
          SLACK_CHANNEL_ID="test-channel"
          REDIS_MAX_CONNECTIONS="10"
          EOF

      - name: Start Docker Test Services
        env:
          ENVIRONMENT: test
        run: |
          make test-start
          echo "Waiting for services to stabilize..."
          sleep 20

      - name: Run Integration Tests (includes E2E workflows)
        env:
          ENVIRONMENT: test
          CI: true
        run: make integration-test

      - name: Stop Docker Environment
        if: always()
        env:
          ENVIRONMENT: test
        run: make test-stop

  # ------------------------------------------------------------------
  # STAGE 4: REGRESSION TESTS (Prevent previously fixed bugs)
  # ------------------------------------------------------------------
  regression-tests:
    runs-on: ubuntu-latest
    needs: [integration-tests]
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: make install

      - name: Create Test Environment Config
        run: |
          mkdir -p env_config/synced
          cat > env_config/synced/.env.test << EOF
          ENVIRONMENT="test"
          CLOUD_PROVIDER="azure"
          USING_FIREBASE_EMULATOR="true"
          FB_AUTH_EMULATOR_HOST="localhost:19099"
          FB_PROJECT_ID="url-shortener-abadb"
          REDIS_URL="redis://localhost:6379"
          MYSQL_USER="root"
          MYSQL_PASSWORD="rootpassword"
          MYSQL_HOST="localhost"
          MYSQL_PORT="3307"
          MYSQL_DATABASE="ai_ticket_platform"
          MYSQL_SYNC_DRIVER="mysql+pymysql"
          MYSQL_ASYNC_DRIVER="mysql+aiomysql"
          AWS_MAIN_REGION="us-east-1"
          S3_MAIN_BUCKET_NAME="test-bucket"
          AZURE_STORAGE_ACCOUNT_NAME="storage_acc"
          AZURE_STORAGE_ACCOUNT_KEY="storage_acc_key"
          AZURE_STORAGE_CONTAINER_NAME="images"
          OPENAI_API_KEY="test-key-123"
          SLACK_BOT_TOKEN="xoxb-test-token"
          GEMINI_API_KEY="test-gemini-key"
          CHROMA_HOST="localhost"
          CHROMA_PORT="8001"
          CHROMA_COLLECTION_NAME="ticket_embeddings"
          GEMINI_MODEL="gemini-1.5-flash"
          FRONTEND_URL="http://localhost:5173"
          SLACK_CHANNEL_ID="test-channel"
          REDIS_MAX_CONNECTIONS="10"
          EOF

      - name: Start Docker Test Services
        env:
          ENVIRONMENT: test
        run: |
          make test-start
          echo "Waiting for services to stabilize..."
          sleep 20

      - name: Run Regression Tests
        env:
          ENVIRONMENT: test
        run: make regression-test

      - name: Stop Docker Environment
        if: always()
        env:
          ENVIRONMENT: test
        run: make test-stop

  # ------------------------------------------------------------------
  # STAGE 5: WORKFLOW & E2E TESTS (Backend Workflows + Full Stack E2E)
  # ------------------------------------------------------------------
  workflow-and-e2e-tests:
    runs-on: ubuntu-latest
    needs: [regression-tests]

    steps:
      - uses: actions/checkout@v4

      # Setup Node.js for frontend
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/app/package-lock.json

      # Setup Python for backend
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "backend/pyproject.toml"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Install dependencies
      - name: Install Backend Dependencies
        working-directory: ./backend
        run: make install

      - name: Install Frontend Dependencies
        working-directory: ./frontend/app
        run: npm ci

      - name: Build Frontend
        working-directory: ./frontend/app
        run: npm run build

      - name: Install E2E Dependencies
        working-directory: ./backend
        run: make e2e-install

      # Create test environment config
      - name: Create Test Environment Config
        working-directory: ./backend
        run: |
          mkdir -p env_config/synced
          cat > env_config/synced/.env.test << EOF
          ENVIRONMENT="test"
          CLOUD_PROVIDER="azure"
          USING_FIREBASE_EMULATOR="true"
          FB_AUTH_EMULATOR_HOST="localhost:19099"
          FB_PROJECT_ID="url-shortener-abadb"
          REDIS_URL="redis://localhost:6379"
          MYSQL_USER="root"
          MYSQL_PASSWORD="rootpassword"
          MYSQL_HOST="localhost"
          MYSQL_PORT="3307"
          MYSQL_DATABASE="ai_ticket_platform"
          MYSQL_SYNC_DRIVER="mysql+pymysql"
          MYSQL_ASYNC_DRIVER="mysql+aiomysql"
          AWS_MAIN_REGION="us-east-1"
          S3_MAIN_BUCKET_NAME="test-bucket"
          AZURE_STORAGE_ACCOUNT_NAME="storage_acc"
          AZURE_STORAGE_ACCOUNT_KEY="storage_acc_key"
          AZURE_STORAGE_CONTAINER_NAME="images"
          OPENAI_API_KEY="test-key-123"
          SLACK_BOT_TOKEN="xoxb-test-token"
          GEMINI_API_KEY="test-gemini-key"
          CHROMA_HOST="localhost"
          CHROMA_PORT="8001"
          CHROMA_COLLECTION_NAME="ticket_embeddings"
          GEMINI_MODEL="gemini-1.5-flash"
          FRONTEND_URL="http://localhost:5173"
          SLACK_CHANNEL_ID="test-channel"
          REDIS_MAX_CONNECTIONS="10"
          EOF

      # Start Docker services
      - name: Start Docker Test Services
        working-directory: ./backend
        env:
          ENVIRONMENT: test
        run: |
          make test-start
          echo "Waiting for Docker services to stabilize..."
          sleep 20

      # Run backend workflow tests first (faster, no frontend needed)
      - name: Run Backend Workflow Tests
        working-directory: ./backend
        env:
          ENVIRONMENT: test
          CI: true
        run: make workflow-test

      # Start backend server
      - name: Start Backend Server
        working-directory: ./backend
        run: |
          source ../.venv/bin/activate
          export $(cat env_config/synced/.env.test | xargs)
          nohup uvicorn src.ai_ticket_platform.main:app --host 0.0.0.0 --port 8000 > ../e2e-backend.log 2>&1 &
          echo $! > ../e2e-backend.pid
          sleep 5

      # Start frontend server
      - name: Start Frontend Server
        working-directory: ./frontend/app
        run: |
          nohup npm run dev > ../../e2e-frontend.log 2>&1 &
          echo $! > ../../e2e-frontend.pid
          sleep 10

      # Verify services are running
      - name: Verify Backend Health
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8000/api/health/ping > /dev/null 2>&1; do sleep 2; echo "Waiting for backend..."; done' || (echo "Backend failed to start" && cat e2e-backend.log && exit 1)

      - name: Verify Frontend Health
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5173 > /dev/null 2>&1; do sleep 2; echo "Waiting for frontend..."; done' || (echo "Frontend failed to start" && cat e2e-frontend.log && exit 1)

      # Create test user in Firebase emulator
      - name: Create Firebase Test User
        run: |
          curl -X POST "http://localhost:19099/identitytoolkit.googleapis.com/v1/accounts:signUp?key=fake-api-key" \
            -H "Content-Type: application/json" \
            -d '{
              "email": "test@example.com",
              "password": "testpassword123",
              "returnSecureToken": true
            }'

      # Run full-stack E2E tests
      - name: Run Full-Stack E2E Tests (Playwright)
        working-directory: ./backend
        env:
          ENVIRONMENT: test
          FRONTEND_URL: http://localhost:5173
        run: make e2e-test

      # Upload test artifacts
      - name: Upload E2E Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 30

      - name: Upload E2E Test Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: e2e/test-results/
          retention-days: 7

      - name: Upload Service Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-service-logs
          path: |
            e2e-backend.log
            e2e-frontend.log
          retention-days: 7

      # Cleanup
      - name: Stop Backend Server
        if: always()
        run: |
          if [ -f e2e-backend.pid ]; then
            kill $(cat e2e-backend.pid) 2>/dev/null || true
            rm e2e-backend.pid
          fi

      - name: Stop Frontend Server
        if: always()
        run: |
          if [ -f e2e-frontend.pid ]; then
            kill $(cat e2e-frontend.pid) 2>/dev/null || true
            rm e2e-frontend.pid
          fi

      - name: Stop Docker Environment
        if: always()
        working-directory: ./backend
        env:
          ENVIRONMENT: test
        run: make test-stop

  # load-tests:
  #   runs-on: ubuntu-latest
  #   needs: [unit-tests, smoke-tests]
  #   if: github.event_name == 'pull_request' && github.base_ref == 'main'
  #   defaults:
  #     run:
  #       working-directory: ${{ env.WORKING_DIR }}

  #   steps:
  #     - uses: actions/checkout@v4

  #     # --- [Setup Steps: Install K6, UV, Python, Dependencies, .env file] ---
  #     # (Copy these from your previous working snippet to keep this readable)
  #     - name: Install k6
  #       run: |
  #         sudo gpg -k
  #         sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
  #         echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
  #         sudo apt-get update
  #         sudo apt-get install k6

  #     - name: Install uv
  #       uses: astral-sh/setup-uv@v3
  #       with:
  #         enable-cache: true
  #         cache-dependency-glob: "backend/pyproject.toml"

  #     - name: Set up Python ${{ env.PYTHON_VERSION }}
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}

  #     - name: Install dependencies
  #       run: make install

  #     - name: Create Test Environment Config
  #       run: |
  #         mkdir -p env_config/synced
  #         cat > env_config/synced/.env.test << EOF
  #         ENVIRONMENT="test"
  #         CLOUD_PROVIDER="azure"
  #         USING_FIREBASE_EMULATOR="true"
  #         FB_AUTH_EMULATOR_HOST="localhost:19099"
  #         FB_PROJECT_ID="url-shortener-abadb"
  #         REDIS_URL="redis://localhost:6379"
  #         MYSQL_USER="root"
  #         MYSQL_PASSWORD="rootpassword"
  #         MYSQL_HOST="database"
  #         MYSQL_PORT="3306"
  #         MYSQL_DATABASE="url_shortener"
  #         MYSQL_SYNC_DRIVER="mysql+pymysql"
  #         MYSQL_ASYNC_DRIVER="mysql+aiomysql"
  #         AWS_MAIN_REGION="us-east-1"
  #         S3_MAIN_BUCKET_NAME="test-bucket"
  #         AZURE_STORAGE_ACCOUNT_NAME="storage_acc"
  #         AZURE_STORAGE_ACCOUNT_KEY="storage_acc_key"
  #         AZURE_STORAGE_CONTAINER_NAME="images"
  #         EOF

  #     - name: Start Full Stack (DB + Backend)
  #       env:
  #         ENVIRONMENT: test
  #       run: make test-start

  #     - name: Verify Backend Health
  #       run: |
  #         timeout 30s bash -c 'until curl -s --fail http://localhost:8000/api/health/ping; do sleep 2; done'

  #     - name: Run Load Tests
  #       run: make load-tests

  #     - name: Stop Docker Environment
  #       if: always()
  #       env:
  #         ENVIRONMENT: test
  #       run: make test-stop

  #     - name: Upload K6 Results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: k6-load-test-results
  #         path: backend/test/load/k6-results.json
